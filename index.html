<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é„­å‘æ™´å°å¯æ„›çš„å€‹äººç©ºé–“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // --- åŸºç¤å…¨åŸŸ UI æ§åˆ¶ ---
        window.isAdmin = false;
        window.currentEditingTarget = null;
        window.currentPhotoData = null; 

        function openLogin() { 
            const modal = document.getElementById('loginModal');
            if (modal) modal.classList.remove('hidden'); 
        }
        
        function closeLogin() { 
            const modal = document.getElementById('loginModal');
            if (modal) modal.classList.add('hidden'); 
            const input = document.getElementById('passwordInput');
            if (input) input.value = ''; 
        }

        // å…¨åŸŸç™»å…¥é‚è¼¯ï¼šæœ€å„ªå…ˆåŸ·è¡Œ
        window.performLogin = function() {
            const pwdInput = document.getElementById('passwordInput');
            if (pwdInput && pwdInput.value === "1234") {
                window.isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('adminBadge')?.classList.remove('hidden');
                document.getElementById('loginBtn')?.classList.add('hidden');
                document.getElementById('logoutBtn')?.classList.remove('hidden');
                document.getElementById('addGalleryBtn')?.classList.remove('hidden');
                
                closeLogin();
                showToast("ç®¡ç†å“¡å·²ç™»å…¥ï¼âœ¨");
                
                // è§¸ç™¼ UI æ›´æ–°
                if (window.renderPhotos && window.currentPhotoData) {
                    window.renderPhotos(window.currentPhotoData);
                }
            } else {
                alert("å¯†ç¢¼ä¸æ­£ç¢ºï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
            }
        };

        window.handleLogout = function() {
            window.isAdmin = false; 
            document.body.classList.remove('is-admin');
            document.getElementById('adminBadge')?.classList.add('hidden');
            document.getElementById('loginBtn')?.classList.remove('hidden');
            document.getElementById('logoutBtn')?.classList.add('hidden');
            document.getElementById('addGalleryBtn')?.classList.add('hidden');
            showToast("å·²ç™»å‡ºç®¡ç†æ¨¡å¼ã€‚");
            if (window.renderPhotos && window.currentPhotoData) {
                window.renderPhotos(window.currentPhotoData);
            }
        };

        window.triggerFilePicker = (target) => {
            if (!window.isAdmin) { showToast("è«‹å…ˆç™»å…¥ç®¡ç†å“¡æ¨¡å¼ï¼ğŸ¬"); return; }
            window.currentEditingTarget = target;
            const fp = document.getElementById('filePicker');
            if (fp) fp.click();
        };

        function handleImgError(img) {
            img.style.display = 'none';
            const container = img.parentElement;
            if (container && !container.querySelector('.loading-placeholder')) {
                const p = document.createElement('div');
                p.className = 'loading-placeholder';
                p.innerText = 'ç­‰å¾…ä¸Šå‚³ GitHub';
                container.appendChild(p);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (t) { 
                t.innerText = msg; t.classList.add('show'); 
                setTimeout(() => t.classList.remove('show'), 3000); 
            }
        }
    </script>

    <style>
        :root { --primary-pink: #ffb7c5; --soft-purple: #e2d1f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #fff5f7 0%, #f0f4ff 100%); scroll-behavior: smooth; overflow-x: hidden; }
        .cute-title { font-family: 'Zhi Mang Xing', cursive, sans-serif; }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .heart-particle { position: absolute; pointer-events: none; animation: flyUp 2s linear forwards; z-index: 100; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .glass-morphism { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .photo-edit-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; cursor: pointer; color: white; z-index: 20; border-radius: inherit; gap: 10px; }
        body.is-admin .photo-container:hover .photo-edit-overlay { opacity: 1; }
        body.is-adjusting .photo-edit-overlay { display: none !important; }
        body.is-adjusting .photo-container.adjust-mode { z-index: 100; }
        body.is-adjusting .adjust-mode .overflow-hidden { overflow: visible !important; }
        body.is-adjusting .adjust-mode img { opacity: 0.5; filter: grayscale(0.2); }
        .adjust-highlight { position: absolute; inset: 0; border: 4px solid #ff69b4; box-shadow: 0 0 0 9999px rgba(0,0,0,0.4); z-index: 10; pointer-events: none; border-radius: inherit; }
        .gallery-item { overflow: hidden; position: relative; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(255, 183, 197, 0.3); background: #fce7f3; transition: all 0.3s ease; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .gallery-item img { transition: transform 0.5s ease; width: 100%; height: 100%; object-fit: cover; }
        .adjust-controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 15px; background: white; padding: 12px 25px; border-radius: 100px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 500; border: 2px solid #ffb7c5; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #ff69b4; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .loading-placeholder { color: #ffb7c5; font-size: 11px; font-weight: bold; text-align: center; }
        
        /* é¸å–å™¨æ”¹ç”¨åç§»é‡éš±è—ï¼Œå¢åŠ é€£å‹•ç©©å®šæ€§ */
        #filePicker { position: absolute; left: -9999px; top: -9999px; opacity: 0; }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast">è¨­å®šå·²æ›´æ–°ï¼âœ¨</div>

    <!-- ç™»å…¥å½ˆçª— -->
    <div id="loginModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl text-center">
            <h3 class="text-2xl font-bold text-pink-500 mb-6 cute-title">ç®¡ç†å“¡ç™»å…¥</h3>
            <input id="passwordInput" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-5 py-3 rounded-full border border-pink-100 mb-4 outline-none focus:ring-2 focus:ring-pink-300 text-center" onkeypress="if(event.key==='Enter') performLogin()">
            <div class="flex space-x-2">
                <button onclick="closeLogin()" class="flex-1 py-3 rounded-full bg-gray-100 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button onclick="performLogin()" class="flex-1 py-3 rounded-full bg-pink-400 text-white font-bold shadow-lg hover:bg-pink-500 transition">ç™»å…¥</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-4 italic">å¯†ç¢¼ï¼š1234</p>
        </div>
    </div>

    <!-- èª¿æ•´å·¥å…·åˆ— -->
    <div id="adjustToolbar" class="adjust-controls hidden">
        <div class="flex flex-col items-center">
            <span class="text-[10px] text-pink-500 font-bold mb-1">ç¸®æ”¾æ¯”ä¾‹</span>
            <input type="range" id="scaleSlider" min="0.5" max="5" step="0.01" value="1" class="w-40 accent-pink-500">
        </div>
        <div class="h-8 w-[1px] bg-gray-200 mx-2"></div>
        <button id="saveTransformBtn" class="bg-pink-500 text-white px-8 py-2 rounded-full font-bold shadow-lg active:scale-95 transition">å®Œæˆä¸¦å„²å­˜</button>
    </div>

    <!-- éš±è—æª”æ¡ˆé¸å–å™¨ -->
    <input type="file" id="filePicker" accept="image/*" multiple>

    <nav class="fixed w-full z-50 glass-morphism px-6 py-4 flex justify-between items-center">
        <div class="text-2xl font-bold text-pink-500">å‘æ™´ ğŸ¬</div>
        <div class="space-x-4 md:space-x-6 hidden sm:flex">
            <a href="#home" class="hover:text-pink-400 transition">é¦–é </a>
            <a href="#about" class="hover:text-pink-400 transition">é—œæ–¼æˆ‘</a>
            <a href="#gallery" class="hover:text-pink-400 transition">ç”œèœœç¬é–“</a>
            <a href="#guestbook" class="hover:text-pink-400 transition">æ‚„æ‚„è©±</a>
        </div>
        <div id="adminBadge" class="hidden bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-xs font-bold animate-pulse border border-pink-200">ç®¡ç†å“¡æ¨¡å¼</div>
    </nav>

    <!-- é¦–é  -->
    <section id="home" class="min-h-screen flex flex-col items-center justify-center pt-20 overflow-hidden relative">
        <div class="text-center z-10 px-4">
            <div class="mb-6 inline-block p-4 rounded-full bg-white shadow-xl floating relative photo-container" id="hero_container">
                <div class="w-48 h-48 md:w-64 md:h-64 rounded-full overflow-hidden border-8 border-pink-100 bg-pink-50 relative flex items-center justify-center" id="hero_frame">
                    <img id="img_hero" src="" alt="å¤§é ­ç…§" class="w-full h-full object-cover origin-center" draggable="false" onerror="handleImgError(this)">
                    <div id="hero_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay">
                    <button onclick="triggerFilePicker('hero')" class="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2">æ›´æ›ç…§ç‰‡</button>
                    <button id="hero_adjust_btn" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-pink-500 mb-4 cute-title">é„­å‘æ™´å°å¯æ„›</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">æ”¶é›†ä¸–é–“æ‰€æœ‰çš„æº«æŸ”èˆ‡å¯æ„› âœ¨</p>
            <button onclick="createHearts(event)" class="bg-pink-400 hover:bg-pink-500 text-white px-10 py-4 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 text-lg font-bold">é€æˆ‘æ„›å¿ƒ ğŸ’–</button>
        </div>
    </section>

    <!-- é—œæ–¼æˆ‘ -->
    <section id="about" class="py-24 px-6 max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">é—œæ–¼å°å¯æ„›</h2>
        <div class="grid md:grid-cols-2 gap-12 items-center">
            <div class="glass-morphism p-10 rounded-3xl shadow-sm leading-relaxed text-gray-700 text-center md:text-left">
                <p class="text-xl mb-6 font-medium">å—¨ï¼æˆ‘æ˜¯å‘æ™´ï¼Œå¤§å®¶å…¬èªçš„å°å¯æ„›ã€‚æˆ‘å–œæ­¡çœ‹æ›¸ã€å½ˆç´ï¼Œä¹Ÿå–œæ­¡å’Œå®¶äººåˆ°è™•å»å†’éšªåƒç¾é£Ÿï¼</p>
                <div class="flex space-x-4">
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ“</span><span class="text-sm font-bold text-pink-400">è‰è“æ´¾</span>
                    </div>
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ¶</span><span class="text-sm font-bold text-pink-400">éŸ³æ¨‚å¤¢</span>
                    </div>
                </div>
            </div>
            <div class="relative photo-container" id="about_container">
                <div class="rounded-3xl overflow-hidden shadow-2xl rotate-2 border-[12px] border-white bg-pink-50 relative h-80 flex items-center justify-center" id="about_frame">
                    <img id="img_about" src="" alt="é—œæ–¼æˆ‘ç…§ç‰‡" class="w-full h-full object-cover origin-center" draggable="false" onerror="handleImgError(this)">
                    <div id="about_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay rotate-2">
                    <button onclick="triggerFilePicker('about')" class="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2">æ›´æ›ç…§ç‰‡</button>
                    <button id="about_adjust_btn" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ç›¸ç°¿ -->
    <section id="gallery" class="py-24 bg-white/40 px-6">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">ç”œèœœç¬é–“</h2>
        <div id="gallery_grid" class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        <div id="addGalleryBtn" class="hidden mt-12 text-center">
            <button id="batchAddBtn" onclick="triggerFilePicker('addGallery')" class="bg-pink-500 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:bg-pink-600 transition flex items-center mx-auto">
                <i data-lucide="plus-circle" class="mr-2"></i> ä¸€æ¬¡é¸å–å¤šå¼µç…§ç‰‡æ–°å¢
            </button>
            <p id="uploadStatus" class="text-xs text-pink-400 mt-4 font-bold"></p>
        </div>
    </section>

    <!-- æ‚„æ‚„è©± -->
    <section id="guestbook" class="py-24 px-6 max-w-2xl mx-auto">
        <div class="glass-morphism p-10 rounded-[2.5rem] shadow-xl text-center">
            <h2 class="text-3xl font-bold text-pink-400 mb-8 cute-title">æ‚„æ‚„è©±ç‰†</h2>
            <div id="messageBox" class="mb-8 space-y-4 max-h-80 overflow-y-auto pr-2 text-sm text-left">
                <div class="text-center py-4 text-gray-400" id="loadingMsg">è¼‰å…¥ç•™è¨€ä¸­...</div>
            </div>
            <div class="flex flex-col space-y-4">
                <input id="userName" type="text" placeholder="ä½ çš„ç¨±å‘¼" class="px-5 py-3 rounded-full border border-pink-100 outline-none">
                <textarea id="userMsg" rows="3" placeholder="æƒ³å°å‘æ™´èªªä»€éº¼ï¼Ÿ" class="px-5 py-3 rounded-3xl border border-pink-100 outline-none"></textarea>
                <button id="sendBtn" class="w-full bg-pink-400 text-white font-bold py-4 rounded-full hover:bg-pink-500 shadow-lg">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-gray-400 text-sm">
        <div class="mb-2 space-x-2">
            <span id="cloudStatus" class="text-[10px] text-gray-300 italic tracking-widest uppercase font-bold">åŒæ­¥ä¸­...</span>
            <span class="text-[10px] text-pink-300 border border-pink-100 px-2 py-0.5 rounded-full">ç‰ˆæœ¬: 2026.02.04.V8.Final</span>
        </div>
        <p>Â© 2025 é„­å‘æ™´å°å¯æ„› â¤ï¸ | <button onclick="openLogin()" id="loginBtn" class="hover:text-pink-300 underline">ç®¡ç†ç™»å…¥</button><button onclick="window.handleLogout()" id="logoutBtn" class="hidden hover:text-red-400">ç™»å‡º</button></p>
    </footer>

    <!-- Firebase æ¨¡çµ„å€ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const GITHUB_URL = "https://shalukuc-debug.github.io/shana/";
        let db, auth, appId, configRef;

        const formatPath = (p) => {
            if (!p) return "";
            if (p.startsWith('http') || p.startsWith('data:')) return p;
            return !window.location.hostname.includes('github.io') ? GITHUB_URL + p : p;
        };

        const defaultPhotos = {
            hero: '4.jpg', heroStyle: { scale: 1, x: 0, y: 0 },
            about: '20.jpg', aboutStyle: { scale: 1, x: 0, y: 0 },
            gallery: ['1.jpg', '2.jpg', '3.jpg', '4.jpg', '5.jpg', '6.jpg', '7.jpg', '8.jpg', '9.jpg', '10.jpg', '20.jpg']
        };

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
        configRef = doc(db, 'artifacts', appId, 'public', 'data', 'photoConfig', 'default');

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                return auth.currentUser;
            } catch (e) { return null; }
        }

        onAuthStateChanged(auth, (u) => { 
            if (u) { 
                document.getElementById('cloudStatus').innerText = "é›²ç«¯åŒæ­¥å·²å°±ç·’ âœ…";
                syncPhotos(); syncMessages(); 
            }
        });

        initAuth();

        // æ¸²æŸ“ç…§ç‰‡ç‰†ï¼šå¾¹åº•ä¿®å¾©æ ¼æ•¸ä¸å°çš„å•é¡Œ
        window.renderPhotos = (data) => {
            const finalData = data || defaultPhotos;
            window.currentPhotoData = JSON.parse(JSON.stringify(finalData)); 
            
            const applyStyle = (id, style) => {
                const img = document.getElementById(id);
                if (style && img) {
                    img.style.objectFit = "contain";
                    img.style.minWidth = "100%"; img.style.minHeight = "100%";
                    img.style.transform = `translate3d(${style.x}px, ${style.y}px, 0) scale(${style.scale})`;
                }
            };

            const hImg = document.getElementById('img_hero');
            if (hImg) { hImg.style.display = 'block'; hImg.src = formatPath(window.currentPhotoData.hero); applyStyle('img_hero', window.currentPhotoData.heroStyle); }
            const aImg = document.getElementById('img_about');
            if (aImg) { aImg.style.display = 'block'; aImg.src = formatPath(window.currentPhotoData.about); applyStyle('img_about', window.currentPhotoData.aboutStyle); }

            const grid = document.getElementById('gallery_grid');
            if (grid) {
                const galleryList = window.currentPhotoData.gallery || [];
                const uniqueGallery = [...new Set(galleryList)]; 
                grid.innerHTML = uniqueGallery.map((name, idx) => `
                    <div class="gallery-item photo-container relative">
                        <img src="${formatPath(name)}" draggable="false" onerror="handleImgError(this)">
                        <div class="photo-edit-overlay flex-col gap-2" onclick="triggerFilePicker('gallery_${idx}')">
                            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                            <span class="text-xs font-bold">æ›´æ›ç…§ç‰‡</span>
                            ${window.isAdmin ? `<button onclick="event.stopPropagation(); window.deleteGalleryItem('${name}')" class="mt-2 bg-red-500 px-3 py-1 rounded-full text-[10px]">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                `).join('');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        function syncPhotos() { 
            onSnapshot(configRef, (snap) => { 
                if(snap.exists()) window.renderPhotos(snap.data()); 
                else { setDoc(configRef, defaultPhotos); window.renderPhotos(defaultPhotos); }
            }); 
        }

        async function secureUpdate(data) {
            if (!auth.currentUser) await initAuth();
            if (auth.currentUser) return await setDoc(configRef, data);
            throw new Error("Unauthenticated");
        }

        // é¸å–æª”æ¡ˆå¾Œçš„è™•ç†æ ¸å¿ƒ
        document.getElementById('filePicker').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            // å¦‚æœé›²ç«¯å°šæœªæœ‰è³‡æ–™ï¼Œä½¿ç”¨é è¨­å€¼å¢Šåº•
            if (!window.currentPhotoData) window.currentPhotoData = JSON.parse(JSON.stringify(defaultPhotos));

            const statusLabel = document.getElementById('uploadStatus');
            const batchBtn = document.getElementById('batchAddBtn');
            const originalBtnHtml = batchBtn?.innerHTML || "";
            
            if (batchBtn) { batchBtn.disabled = true; batchBtn.innerHTML = "åŒæ­¥ä¸­..."; }
            if (statusLabel) statusLabel.innerText = `â³ æ­£åœ¨å¯«å…¥é›²ç«¯...`;

            const newData = { ...window.currentPhotoData };
            const target = window.currentEditingTarget;

            if (target === 'hero') newData.hero = files[0].name;
            else if (target === 'about') newData.about = files[0].name;
            else if (target === 'addGallery') {
                const names = files.map(f => f.name);
                newData.gallery = [...new Set([...(newData.gallery || []), ...names])];
            } else if (target.startsWith('gallery_')) {
                const idx = parseInt(target.split('_')[1]);
                if (newData.gallery) newData.gallery[idx] = files[0].name;
            }

            try { 
                await secureUpdate(newData); 
                showToast("åŒæ­¥æˆåŠŸï¼è¨˜å¾—ä¸Šå‚³åœ–æª”è‡³ GitHub âœ¨");
                if (statusLabel) statusLabel.innerText = "âœ… å·²æ›´æ–°ï¼è«‹å‹™å¿…å‚³åœ–æª”è‡³ GitHubã€‚";
            } catch (err) { 
                console.error(err);
                alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚"); 
            } finally { 
                if (batchBtn) { batchBtn.disabled = false; batchBtn.innerHTML = originalBtnHtml; } 
                e.target.value = ''; 
            }
        });

        // èª¿æ•´ä½ç½®åŠŸèƒ½
        let adjustState = { target: null, isDragging: false, startX: 0, startY: 0, currentX: 0, currentY: 0, scale: 1 };
        const initAdjust = (type) => {
            if (!window.currentPhotoData) return;
            adjustState.target = type;
            const style = window.currentPhotoData[`${type}Style`] || { scale: 1, x: 0, y: 0 };
            adjustState.currentX = style.x; adjustState.currentY = style.y; adjustState.scale = style.scale;
            document.body.classList.add('is-adjusting');
            document.getElementById(`${type}_container`).classList.add('adjust-mode');
            document.getElementById(`${type}_highlight`).classList.remove('hidden');
            document.getElementById('adjustToolbar').classList.remove('hidden');
            const slider = document.getElementById('scaleSlider');
            slider.value = adjustState.scale;
            slider.oninput = (ev) => { adjustState.scale = parseFloat(ev.target.value); updateTransform(); };
            const img = document.getElementById(`img_${type}`);
            img.onmousedown = (ev) => { 
                adjustState.isDragging = true; 
                adjustState.startX = ev.clientX - adjustState.currentX; adjustState.startY = ev.clientY - adjustState.currentY;
                window.onmousemove = (mv) => { 
                    if (!adjustState.isDragging) return;
                    adjustState.currentX = mv.clientX - adjustState.startX; adjustState.currentY = mv.clientY - adjustState.startY;
                    updateTransform();
                };
                window.onmouseup = () => { adjustState.isDragging = false; window.onmousemove = null; };
                ev.preventDefault();
            };
        };
        document.getElementById('hero_adjust_btn').onclick = () => initAdjust('hero');
        document.getElementById('about_adjust_btn').onclick = () => initAdjust('about');

        function updateTransform() {
            const img = document.getElementById(`img_${adjustState.target}`);
            if (img) img.style.transform = `translate3d(${adjustState.currentX}px, ${adjustState.currentY}px, 0) scale(${adjustState.scale})`;
        }

        document.getElementById('saveTransformBtn').onclick = async () => {
            const btn = document.getElementById('saveTransformBtn');
            const originalText = btn.innerText; btn.innerText = "åŒæ­¥ä¸­...";
            const newData = JSON.parse(JSON.stringify(window.currentPhotoData));
            newData[`${adjustState.target}Style`] = { scale: adjustState.scale, x: adjustState.currentX, y: adjustState.currentY };
            try {
                await secureUpdate(newData);
                document.body.classList.remove('is-adjusting');
                document.querySelectorAll('.adjust-mode').forEach(el => el.classList.remove('adjust-mode'));
                document.querySelectorAll('.adjust-highlight').forEach(el => el.classList.add('hidden'));
                document.getElementById('adjustToolbar').classList.add('hidden');
                showToast("å®Œç¾è§’åº¦å·²å„²å­˜ï¼âœ¨");
            } catch (e) { showToast("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦"); } finally { btn.innerText = originalText; }
        };

        window.deleteGalleryItem = async (fileName) => {
            if (!confirm("ç¢ºå®šåˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) return;
            const newData = { ...window.currentPhotoData };
            newData.gallery = newData.gallery.filter(name => name !== fileName);
            await secureUpdate(newData);
            showToast("ç…§ç‰‡å·²ç§»é™¤ã€‚");
        };

        function syncMessages() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                const loading = document.getElementById('loadingMsg'); if (loading) loading.remove();
                const msgs = []; snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                const box = document.getElementById('messageBox');
                if (box) box.innerHTML = msgs.map(m => `
                    <div class="bg-white/90 p-4 rounded-2xl shadow-sm border-l-4 border-pink-300 mb-3 text-left">
                        <span class="font-bold text-pink-500">${m.name || 'è¨ªå®¢'}:</span> ${m.content}
                    </div>
                `).join('') || '<div class="text-center text-gray-400 py-4">ç›®å‰é‚„æ²’æœ‰ç•™è¨€å–”</div>';
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const n = document.getElementById('userName').value, c = document.getElementById('userMsg').value;
            if (!n || !c) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), { name: n, content: c, createdAt: serverTimestamp() });
                document.getElementById('userName').value = ''; document.getElementById('userMsg').value = '';
                createHearts();
            } catch (e) { }
        };
    </script>

    <script>
        function createHearts(e) {
            const x = e ? e.clientX : window.innerWidth/2, y = e ? e.clientY : window.innerHeight/2;
            for(let i=0; i<15; i++) {
                const h = document.createElement('div');
                h.innerHTML = ['ğŸ’–','ğŸ’—','âœ¨','ğŸŒ¸','ğŸ­'][Math.floor(Math.random()*5)];
                h.className = 'heart-particle text-3xl';
                h.style.left = x + (Math.random()-0.5)*180 + 'px';
                h.style.top = y + (Math.random()-0.5)*180 + 'px';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 2000);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é„­å‘æ™´å°å¯æ„›çš„å€‹äººç©ºé–“</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --primary-pink: #ffb7c5; --soft-purple: #e2d1f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #fff5f7 0%, #f0f4ff 100%); scroll-behavior: smooth; overflow-x: hidden; }
        .cute-title { font-family: 'Zhi Mang Xing', cursive, sans-serif; }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .heart-particle { position: absolute; pointer-events: none; animation: flyUp 2s linear forwards; z-index: 100; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .glass-morphism { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        /* ç®¡ç†å“¡ UI ç‰¹æ•ˆ */
        .photo-edit-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; cursor: pointer; color: white; z-index: 20; border-radius: inherit; gap: 8px; }
        body.is-admin .photo-container:hover .photo-edit-overlay { opacity: 1; }
        
        /* èª¿æ•´æ¨¡å¼ç‰¹æ•ˆ */
        body.is-adjusting .photo-edit-overlay { display: none !important; }
        body.is-adjusting .photo-container.adjust-mode { z-index: 100; }
        body.is-adjusting .adjust-mode .overflow-hidden { overflow: visible !important; }
        body.is-adjusting .adjust-mode img { opacity: 0.6; filter: brightness(1.1); cursor: move; }
        .adjust-highlight { position: absolute; inset: 0; border: 4px solid #ff69b4; box-shadow: 0 0 0 9999px rgba(0,0,0,0.4); z-index: 10; pointer-events: none; border-radius: inherit; }
        
        /* ç…§ç‰‡ç‰†é …ç›® */
        .gallery-item { overflow: hidden; position: relative; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(255, 183, 197, 0.3); background: #fce7f3; transition: all 0.3s ease; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        
        .adjust-controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 15px; background: white; padding: 12px 25px; border-radius: 100px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 500; border: 2px solid #ffb7c5; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #ff69b4; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; }
        .loading-placeholder { color: #ffb7c5; font-size: 11px; font-weight: bold; text-align: center; }
        
        #filePicker { position: absolute; left: -9999px; opacity: 0; pointer-events: none; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast">è¨­å®šå·²åŒæ­¥ï¼âœ¨</div>

    <!-- ç®¡ç†å“¡ç™»å…¥å½ˆçª— -->
    <div id="loginModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl text-center">
            <h3 class="text-2xl font-bold text-pink-500 mb-6 cute-title">ç®¡ç†å“¡ç™»å…¥</h3>
            <input id="passwordInput" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-5 py-3 rounded-full border border-pink-100 mb-4 outline-none focus:ring-2 focus:ring-pink-300 text-center">
            <div class="flex space-x-2">
                <button id="closeLoginBtn" class="flex-1 py-3 rounded-full bg-gray-100 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button id="performLoginBtn" class="flex-1 py-3 rounded-full bg-pink-400 text-white font-bold shadow-lg hover:bg-pink-500 transition">ç™»å…¥</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-4">é è¨­ï¼š1234</p>
        </div>
    </div>

    <!-- åœ–ç‰‡èª¿æ•´å·¥å…·åˆ— -->
    <div id="adjustToolbar" class="adjust-controls hidden">
        <div class="flex flex-col items-center">
            <span class="text-[10px] text-pink-500 font-bold mb-1 uppercase">ç¸®æ”¾æ¯”ä¾‹</span>
            <input type="range" id="scaleSlider" min="0.5" max="5" step="0.01" value="1" class="w-40 accent-pink-500">
        </div>
        <div class="h-8 w-[1px] bg-gray-200 mx-2"></div>
        <button id="saveAdjustBtn" class="bg-pink-500 text-white px-8 py-2 rounded-full font-bold shadow-lg hover:bg-pink-600 transition active:scale-95">å®Œæˆä¸¦å„²å­˜</button>
    </div>

    <!-- å…¨ç¶²å”¯ä¸€æª”æ¡ˆé¸å–å™¨ -->
    <input type="file" id="filePicker" accept="image/*" multiple>

    <nav class="fixed w-full z-50 glass-morphism px-6 py-4 flex justify-between items-center">
        <div class="text-2xl font-bold text-pink-500">å‘æ™´ ğŸ¬</div>
        <div class="space-x-4 md:space-x-6 hidden sm:flex">
            <a href="#home" class="hover:text-pink-400 transition">é¦–é </a>
            <a href="#about" class="hover:text-pink-400 transition">é—œæ–¼æˆ‘</a>
            <a href="#gallery" class="hover:text-pink-400 transition">ç”œèœœç¬é–“</a>
            <a href="#guestbook" class="hover:text-pink-400 transition">æ‚„æ‚„è©±</a>
        </div>
        <div id="adminBadge" class="hidden bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-xs font-bold animate-pulse border border-pink-200">ç®¡ç†å“¡æ¨¡å¼</div>
    </nav>

    <!-- é¦–é å€å¡Š -->
    <section id="home" class="min-h-screen flex flex-col items-center justify-center pt-20 overflow-hidden relative">
        <div class="text-center z-10 px-4">
            <div class="mb-6 inline-block p-4 rounded-full bg-white shadow-xl floating relative photo-container" id="hero_container">
                <div class="w-48 h-48 md:w-64 md:h-64 rounded-full overflow-hidden border-8 border-pink-100 bg-pink-50 relative flex items-center justify-center" id="hero_frame">
                    <img id="img_hero" src="" alt="å¤§é ­ç…§" class="w-full h-full object-cover origin-center" draggable="false">
                    <div id="hero_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay">
                    <button class="trigger-picker-btn bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2" data-target="hero">æ›´æ›ç…§ç‰‡</button>
                    <button class="trigger-adjust-btn bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md" data-target="hero">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-pink-500 mb-4 cute-title">é„­å‘æ™´å°å¯æ„›</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">æ”¶é›†ä¸–é–“æ‰€æœ‰çš„æº«æŸ”èˆ‡å¯æ„› âœ¨</p>
            <button id="giveHeartBtn" class="bg-pink-400 hover:bg-pink-500 text-white px-10 py-4 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 text-lg font-bold">é€æˆ‘æ„›å¿ƒ ğŸ’–</button>
        </div>
    </section>

    <!-- é—œæ–¼æˆ‘ -->
    <section id="about" class="py-24 px-6 max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">é—œæ–¼å°å¯æ„›</h2>
        <div class="grid md:grid-cols-2 gap-12 items-center">
            <div class="glass-morphism p-10 rounded-3xl shadow-sm leading-relaxed text-gray-700">
                <p class="text-xl mb-6 font-medium text-center md:text-left">å—¨ï¼æˆ‘æ˜¯å‘æ™´ï¼Œå¤§å®¶å…¬èªçš„å°å¯æ„›ã€‚æˆ‘å–œæ­¡çœ‹æ›¸ã€å½ˆç´ï¼Œä¹Ÿå–œæ­¡å’Œå®¶äººåˆ°è™•å»å†’éšªåƒç¾é£Ÿï¼</p>
                <div class="flex space-x-4">
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ“</span><span class="text-sm font-bold text-pink-400">è‰è“æ´¾</span>
                    </div>
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ¶</span><span class="text-sm font-bold text-pink-400">éŸ³æ¨‚å¤¢</span>
                    </div>
                </div>
            </div>
            <div class="relative photo-container" id="about_container">
                <div class="rounded-3xl overflow-hidden shadow-2xl rotate-2 border-[12px] border-white bg-pink-50 relative h-80 flex items-center justify-center" id="about_frame">
                    <img id="img_about" src="" alt="é—œæ–¼æˆ‘ç…§ç‰‡" class="w-full h-full object-cover origin-center" draggable="false">
                    <div id="about_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay rotate-2">
                    <button class="trigger-picker-btn bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2" data-target="about">æ›´æ›ç…§ç‰‡</button>
                    <button class="trigger-adjust-btn bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md" data-target="about">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ç›¸ç°¿ -->
    <section id="gallery" class="py-24 bg-white/40 px-6">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">ç”œèœœç¬é–“</h2>
        <div id="gallery_grid" class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        <div id="addGalleryBtn" class="hidden mt-12 text-center">
            <button class="trigger-picker-btn bg-pink-500 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:bg-pink-600 transition flex items-center mx-auto" data-target="addGallery">
                <i data-lucide="plus-circle" class="mr-2"></i> ä¸€æ¬¡é¸å–å¤šå¼µç…§ç‰‡æ–°å¢
            </button>
            <p id="uploadStatus" class="text-xs text-pink-400 mt-4 font-bold"></p>
        </div>
    </section>

    <!-- æ‚„æ‚„è©± -->
    <section id="guestbook" class="py-24 px-6 max-w-2xl mx-auto">
        <div class="glass-morphism p-10 rounded-[2.5rem] shadow-xl text-center">
            <h2 class="text-3xl font-bold text-pink-400 mb-8 cute-title">æ‚„æ‚„è©±ç‰†</h2>
            <div id="messageBox" class="mb-8 space-y-4 max-h-80 overflow-y-auto pr-2 text-sm text-left">
                <div class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="flex flex-col space-y-4">
                <input id="guestName" type="text" placeholder="ä½ çš„ç¨±å‘¼" class="px-5 py-3 rounded-full border border-pink-100 outline-none">
                <textarea id="guestMsg" rows="3" placeholder="æƒ³å°å‘æ™´èªªä»€éº¼ï¼Ÿ" class="px-5 py-3 rounded-3xl border border-pink-100 outline-none"></textarea>
                <button id="sendMsgBtn" class="w-full bg-pink-400 text-white font-bold py-4 rounded-full hover:bg-pink-500 shadow-lg">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-gray-400 text-sm">
        <div class="mb-2 space-x-2">
            <span id="cloudStatus" class="text-[10px] text-gray-300 italic">é€£ç·šä¸­...</span>
            <span class="text-[10px] text-pink-200 border border-pink-50 px-2 py-0.5 rounded-full">ç‰ˆæœ¬: 2026.02.04.V12.Unified</span>
        </div>
        <p>Â© 2025 é„­å‘æ™´å°å¯æ„› â¤ï¸ | <button id="loginBtn" class="hover:text-pink-300 underline">ç®¡ç†ç™»å…¥</button><button id="logoutBtn" class="hidden hover:text-red-400 ml-2">ç™»å‡º</button></p>
    </footer>

    <!-- Firebase æ ¸å¿ƒæ¨¡çµ„ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // é…ç½®
        const GITHUB_URL = "https://shalukuc-debug.github.io/shana/";
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shana-cute';
        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'photoConfig', 'default');

        // é è¨­ç…§ç‰‡
        const defaultData = {
            hero: '4.jpg', heroStyle: { scale: 1, x: 0, y: 0 },
            about: '20.jpg', aboutStyle: { scale: 1, x: 0, y: 0 },
            gallery: ['1.jpg', '2.jpg', '3.jpg', '4.jpg', '5.jpg', '6.jpg', '7.jpg', '8.jpg', '9.jpg', '10.jpg', '20.jpg']
        };

        let state = {
            photoData: defaultData,
            isAdmin: false,
            target: null,
            adjust: { x: 0, y: 0, scale: 1, isDragging: false, startX: 0, startY: 0 }
        };

        // --- UI è¼”åŠ©å‡½æ•¸ ---
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            if (t) { t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        };

        const handleImgError = (img) => {
            img.style.display = 'none';
            if (!img.parentElement.querySelector('.loading-placeholder')) {
                const p = document.createElement('div');
                p.className = 'loading-placeholder';
                p.innerText = 'ç­‰å¾… GitHub è³‡æº';
                img.parentElement.appendChild(p);
            }
        };

        // --- æ ¸å¿ƒæ¸²æŸ“å¼•æ“ ---
        const renderPhotos = (data) => {
            state.photoData = data || defaultData;
            const path = (n) => n && (n.startsWith('http') || n.startsWith('data:')) ? n : GITHUB_URL + n;

            const updateImg = (id, name, style) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.src = path(name);
                el.onerror = () => handleImgError(el);
                if (style) {
                    el.style.objectFit = "contain"; el.style.minWidth = "100%"; el.style.minHeight = "100%";
                    el.style.transform = `translate3d(${style.x}px, ${style.y}px, 0) scale(${style.scale})`;
                }
            };

            updateImg('img_hero', state.photoData.hero, state.photoData.heroStyle);
            updateImg('img_about', state.photoData.about, state.photoData.aboutStyle);

            const grid = document.getElementById('gallery_grid');
            if (grid) {
                const list = [...new Set(state.photoData.gallery || [])];
                grid.innerHTML = list.map((name, idx) => `
                    <div class="gallery-item photo-container relative">
                        <img src="${path(name)}" draggable="false" onerror="this.style.display='none'; this.parentElement.innerHTML+='<div class=\'loading-placeholder\'>ç­‰å¾…è³‡æº</div>'">
                        <div class="photo-edit-overlay flex-col gap-2">
                            <button class="trigger-picker-btn bg-white/20 hover:bg-white/40 px-4 py-1 rounded-full text-[10px] font-bold" data-target="gallery_${idx}">æ›´æ›</button>
                            ${state.isAdmin ? `<button class="del-btn bg-red-500/80 px-4 py-1 rounded-full text-[10px] font-bold" data-name="${name}">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                `).join('');
                
                // é‡æ–°ç¶å®šäº‹ä»¶
                grid.querySelectorAll('.trigger-picker-btn').forEach(b => b.onclick = () => startPicker(b.dataset.target));
                grid.querySelectorAll('.del-btn').forEach(b => b.onclick = () => deletePhoto(b.dataset.name));
            }
            lucide.createIcons();
        };

        const deletePhoto = async (name) => {
            if (confirm("ç¢ºå®šåˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ")) {
                const newData = { ...state.photoData };
                newData.gallery = newData.gallery.filter(n => n !== name);
                await saveToCloud(newData);
            }
        };

        const saveToCloud = async (newData) => {
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                await setDoc(configRef, newData);
                showToast("åŒæ­¥æˆåŠŸï¼âœ¨");
            } catch (e) { alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
        };

        const startPicker = (target) => {
            if (!state.isAdmin) { showToast("è«‹å…ˆç™»å…¥ç®¡ç†å“¡å–”ï¼ğŸ¬"); return; }
            state.target = target;
            document.getElementById('filePicker').click();
        };

        const startAdjust = (type) => {
            state.target = type;
            const style = state.photoData[`${type}Style`] || { scale: 1, x: 0, y: 0 };
            state.adjust = { ...style, isDragging: false };
            
            document.body.classList.add('is-adjusting');
            document.getElementById(`${type}_container`).classList.add('adjust-mode');
            document.getElementById(`${type}_highlight`).classList.remove('hidden');
            document.getElementById('adjustToolbar').classList.remove('hidden');
            
            const slider = document.getElementById('scaleSlider');
            slider.value = state.adjust.scale;
            slider.oninput = (e) => { state.adjust.scale = parseFloat(e.target.value); updateAdjustView(); };
            
            const img = document.getElementById(`img_${type}`);
            img.onmousedown = (e) => {
                state.adjust.isDragging = true;
                state.adjust.startX = e.clientX - state.adjust.x;
                state.adjust.startY = e.clientY - state.adjust.y;
                window.onmousemove = (mv) => {
                    if (!state.adjust.isDragging) return;
                    state.adjust.x = mv.clientX - state.adjust.startX;
                    state.adjust.y = mv.clientY - state.adjust.startY;
                    updateAdjustView();
                };
                window.onmouseup = () => { state.adjust.isDragging = false; window.onmousemove = null; };
                e.preventDefault();
            };
        };

        const updateAdjustView = () => {
            const img = document.getElementById(`img_${state.target}`);
            if (img) img.style.transform = `translate3d(${state.adjust.x}px, ${state.adjust.y}px, 0) scale(${state.adjust.scale})`;
        };

        // --- æŒ‰éˆ•äº‹ä»¶ç¶å®š (Module å…§éƒ¨) ---
        const bindEvents = () => {
            // ç™»å…¥
            document.getElementById('loginBtn').onclick = () => document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('closeLoginBtn').onclick = () => document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('performLoginBtn').onclick = () => {
                if (document.getElementById('passwordInput').value === "1234") {
                    state.isAdmin = true;
                    document.body.classList.add('is-admin');
                    document.getElementById('adminBadge').classList.remove('hidden');
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('addGalleryBtn').classList.remove('hidden');
                    document.getElementById('loginModal').classList.add('hidden');
                    showToast("ç®¡ç†å“¡å·²ç™»å…¥ï¼âœ¨");
                    renderPhotos(state.photoData);
                } else alert("å¯†ç¢¼éŒ¯èª¤");
            };

            document.getElementById('logoutBtn').onclick = () => {
                state.isAdmin = false;
                document.body.classList.remove('is-admin');
                document.getElementById('adminBadge').classList.add('hidden');
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('addGalleryBtn').classList.add('hidden');
                renderPhotos(state.photoData);
            };

            // æª”æ¡ˆè™•ç†
            document.getElementById('filePicker').onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                const status = document.getElementById('uploadStatus');
                if (status) status.innerText = "â³ åŒæ­¥ä¸­...";
                const newData = { ...state.photoData };
                if (state.target === 'hero') newData.hero = files[0].name;
                else if (state.target === 'about') newData.about = files[0].name;
                else if (state.target === 'addGallery') {
                    const names = files.map(f => f.name);
                    newData.gallery = [...new Set([...(newData.gallery || []), ...names])];
                } else if (state.target.startsWith('gallery_')) {
                    const idx = parseInt(state.target.split('_')[1]);
                    newData.gallery[idx] = files[0].name;
                }
                await saveToCloud(newData);
                if (status) status.innerText = "âœ… å·²æ›´æ–°ï¼";
                e.target.value = '';
            };

            // èª¿æ•´ä¿å­˜
            document.getElementById('saveAdjustBtn').onclick = async () => {
                const newData = { ...state.photoData };
                newData[`${state.target}Style`] = { scale: state.adjust.scale, x: state.adjust.x, y: state.adjust.y };
                await saveToCloud(newData);
                document.body.classList.remove('is-adjusting');
                document.querySelectorAll('.photo-container').forEach(el => el.classList.remove('adjust-mode'));
                document.querySelectorAll('.adjust-highlight').forEach(el => el.classList.add('hidden'));
                document.getElementById('adjustToolbar').classList.add('hidden');
            };

            // å…¶ä»–
            document.querySelectorAll('.trigger-picker-btn').forEach(b => b.onclick = () => startPicker(b.dataset.target));
            document.querySelectorAll('.trigger-adjust-btn').forEach(b => b.onclick = () => startAdjust(b.dataset.target));
            document.getElementById('sendMsgBtn').onclick = async () => {
                const n = document.getElementById('guestName').value, c = document.getElementById('guestMsg').value;
                if (!n || !c) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), { name: n, content: c, createdAt: serverTimestamp() });
                document.getElementById('guestName').value = ''; document.getElementById('guestMsg').value = '';
            };
            document.getElementById('giveHeartBtn').onclick = (e) => {
                const x = e.clientX, y = e.clientY;
                for(let i=0; i<15; i++) {
                    const h = document.createElement('div');
                    h.innerHTML = ['ğŸ’–','ğŸ’—','âœ¨','ğŸŒ¸','ğŸ­'][Math.floor(Math.random()*5)];
                    h.className = 'heart-particle text-3xl';
                    h.style.left = x + (Math.random()-0.5)*180 + 'px'; h.style.top = y + (Math.random()-0.5)*180 + 'px';
                    document.body.appendChild(h); setTimeout(() => h.remove(), 2000);
                }
            };
        };

        // --- åˆå§‹åŒ–å•Ÿå‹• ---
        const init = async () => {
            renderPhotos(defaultData); // å•Ÿå‹•å³é¡¯ç¤º
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);

            onAuthStateChanged(auth, (u) => {
                if (u) {
                    document.getElementById('cloudStatus').innerText = "é›²ç«¯åŒæ­¥å·²å°±ç·’ âœ…";
                    onSnapshot(configRef, (snap) => {
                        if (snap.exists()) renderPhotos(snap.data());
                        else saveToCloud(defaultData);
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                        const msgs = []; snap.forEach(d => msgs.push(d.data()));
                        msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        const box = document.getElementById('messageBox');
                        if (box) box.innerHTML = msgs.map(m => `
                            <div class="bg-white/90 p-4 rounded-2xl shadow-sm border-l-4 border-pink-300 mb-2">
                                <span class="font-bold text-pink-500">${m.name || 'è¨ªå®¢'}:</span> ${m.content}
                            </div>
                        `).join('') || '<div class="text-center py-4 text-gray-400">ç›®å‰å°šç„¡ç•™è¨€</div>';
                    });
                }
            });
            bindEvents();
        };

        init();
    </script>
</body>
</html>

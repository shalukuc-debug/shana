<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é„­å‘æ™´å°å¯æ„›çš„å€‹äººç©ºé–“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <!-- ä½¿ç”¨ Lucide åœ–ç¤º -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary-pink: #ffb7c5; --soft-purple: #e2d1f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #fff5f7 0%, #f0f4ff 100%); scroll-behavior: smooth; overflow-x: hidden; }
        .cute-title { font-family: 'Zhi Mang Xing', cursive, sans-serif; }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .heart-particle { position: absolute; pointer-events: none; animation: flyUp 2s linear forwards; z-index: 100; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .glass-morphism { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        /* ç®¡ç†é®ç½©æ¨£å¼ */
        .photo-edit-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer; color: white;
            z-index: 20; border-radius: inherit; pointer-events: none; gap: 10px;
        }
        body.is-admin .photo-container:hover .photo-edit-overlay { opacity: 1; pointer-events: auto; }
        
        /* èª¿æ•´æ¨¡å¼æ¿€æ´»æ™‚çš„ç‰¹æ•ˆï¼šè®“æ¡†æ¡†å¤–è®ŠåŠé€æ˜ */
        body.is-adjusting .photo-edit-overlay { display: none !important; }
        body.is-adjusting .photo-container.adjust-mode { z-index: 100; }
        body.is-adjusting .adjust-mode .overflow-hidden { overflow: visible !important; }
        body.is-adjusting .adjust-mode img { opacity: 0.6; }
        /* äº®å€ä»£è¡¨å¯¦éš›æœƒé¡¯ç¤ºçš„ç¯„åœ */
        .adjust-highlight {
            position: absolute; inset: 0; border: 4px solid #ff69b4; 
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.4); z-index: 10; pointer-events: none;
            border-radius: inherit;
        }

        .gallery-item { overflow: hidden; position: relative; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(255, 183, 197, 0.3); background: #fce7f3; transition: all 0.3s ease; min-height: 150px; }
        .gallery-item img { transition: transform 0.5s ease; width: 100%; height: 100%; object-fit: cover; }
        
        /* èª¿æ•´æ¨¡å¼å°ˆç”¨æ§åˆ¶é … */
        .adjust-controls {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 15px; background: white;
            padding: 12px 25px; border-radius: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 200; border: 2px solid #ffb7c5;
        }

        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #ff69b4; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast">è¨­å®šå·²æ›´æ–°ï¼âœ¨</div>

    <!-- ç™»å…¥å½ˆçª— -->
    <div id="loginModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl">
            <h3 class="text-2xl font-bold text-pink-500 mb-6 text-center">ç®¡ç†å“¡ç™»å…¥</h3>
            <input id="passwordInput" type="password" placeholder="ç®¡ç†å¯†ç¢¼" class="w-full px-5 py-3 rounded-full border border-pink-100 mb-4 outline-none focus:ring-2 focus:ring-pink-300">
            <div class="flex space-x-2">
                <button onclick="closeLogin()" class="flex-1 py-3 rounded-full bg-gray-100 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button id="loginConfirmBtn" class="flex-1 py-3 rounded-full bg-pink-400 text-white font-bold shadow-lg hover:bg-pink-500 transition active:scale-95">ç™»å…¥</button>
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-4 italic">è«‹è¼¸å…¥å°ˆå±¬å¯†ç¢¼ä»¥é–‹å•Ÿç…§ç‰‡èª¿æ•´åŠŸèƒ½</p>
        </div>
    </div>

    <!-- èª¿æ•´ä¸­çš„æ§åˆ¶æµ®çª— -->
    <div id="adjustToolbar" class="adjust-controls hidden">
        <div class="flex flex-col items-center">
            <span class="text-[10px] text-pink-500 font-bold mb-1 uppercase tracking-widest">ç¸®æ”¾æ¯”ä¾‹</span>
            <div class="flex items-center gap-3">
                <i data-lucide="minus" class="w-4 h-4 text-gray-400"></i>
                <input type="range" id="scaleSlider" min="0.5" max="5" step="0.01" value="1" class="w-40 accent-pink-500">
                <i data-lucide="plus" class="w-4 h-4 text-gray-400"></i>
            </div>
        </div>
        <div class="h-8 w-[1px] bg-gray-200 mx-2"></div>
        <button onclick="saveVisualTransform()" class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-pink-600 transition active:scale-95">å®Œæˆå„²å­˜</button>
    </div>

    <input type="file" id="filePicker" class="hidden" accept="image/*" multiple>

    <nav class="fixed w-full z-50 glass-morphism px-6 py-4 flex justify-between items-center">
        <div class="text-2xl font-bold text-pink-500">å‘æ™´ ğŸ¬</div>
        <div class="space-x-4 md:space-x-6 hidden sm:flex">
            <a href="#home" class="hover:text-pink-400 transition">é¦–é </a>
            <a href="#about" class="hover:text-pink-400 transition">é—œæ–¼æˆ‘</a>
            <a href="#gallery" class="hover:text-pink-400 transition">ç”œèœœç¬é–“</a>
            <a href="#guestbook" class="hover:text-pink-400 transition">æ‚„æ‚„è©±</a>
        </div>
        <div id="adminBadge" class="hidden bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-xs font-bold animate-pulse border border-pink-200">
            ç®¡ç†å“¡æ¨¡å¼
        </div>
    </nav>

    <!-- é¦–é  -->
    <section id="home" class="min-h-screen flex flex-col items-center justify-center pt-20 overflow-hidden relative">
        <div class="text-center z-10 px-4">
            <div class="mb-6 inline-block p-4 rounded-full bg-white shadow-xl floating relative photo-container" id="hero_container">
                <div class="w-44 h-44 md:w-64 md:h-64 rounded-full overflow-hidden border-8 border-pink-100 bg-pink-50 relative" id="hero_frame">
                    <img id="img_hero" src="" alt="å¤§é ­ç…§" class="w-full h-full object-cover origin-center" draggable="false">
                    <div id="hero_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay">
                    <button onclick="triggerFilePicker('hero')" class="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2">æ›´æ›ç…§ç‰‡</button>
                    <button onclick="enterAdjustMode('hero')" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-pink-500 mb-4 cute-title">é„­å‘æ™´å°å¯æ„›</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">æ”¶é›†ä¸–é–“æ‰€æœ‰çš„æº«æŸ”èˆ‡å¯æ„› âœ¨</p>
            <button onclick="createHearts(event)" class="bg-pink-400 hover:bg-pink-500 text-white px-10 py-4 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 text-lg font-bold">
                é€æˆ‘æ„›å¿ƒ ğŸ’–
            </button>
        </div>
    </section>

    <!-- é—œæ–¼æˆ‘ -->
    <section id="about" class="py-24 px-6 max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">é—œæ–¼å°å¯æ„›</h2>
        <div class="grid md:grid-cols-2 gap-12 items-center">
            <div class="glass-morphism p-10 rounded-3xl shadow-sm leading-relaxed text-gray-700">
                <p class="text-xl mb-6 font-medium">å—¨ï¼æˆ‘æ˜¯å‘æ™´ï¼Œå¤§å®¶å…¬èªçš„å°å¯æ„›ã€‚æˆ‘å–œæ­¡çœ‹æ›¸ã€å½ˆç´ï¼Œä¹Ÿå–œæ­¡å’Œå®¶äººåˆ°è™•å»å†’éšªåƒç¾é£Ÿï¼</p>
                <div class="flex space-x-4">
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ“</span><span class="text-sm font-bold text-pink-400">è‰è“æ´¾</span>
                    </div>
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50 flex-1 text-center">
                        <span class="block text-3xl">ğŸ¶</span><span class="text-sm font-bold text-pink-400">éŸ³æ¨‚å¤¢</span>
                    </div>
                </div>
            </div>
            <div class="relative photo-container" id="about_container">
                <div class="rounded-3xl overflow-hidden shadow-2xl rotate-2 border-[12px] border-white bg-pink-50 relative h-80" id="about_frame">
                    <img id="img_about" src="" alt="é—œæ–¼æˆ‘ç…§ç‰‡" class="w-full h-full object-cover origin-center" draggable="false">
                    <div id="about_highlight" class="adjust-highlight hidden"></div>
                </div>
                <div class="photo-edit-overlay rotate-2">
                    <button onclick="triggerFilePicker('about')" class="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full text-xs font-bold mb-2">æ›´æ›ç…§ç‰‡</button>
                    <button onclick="enterAdjustMode('about')" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-full text-xs font-bold shadow-md">èª¿æ•´ä½ç½®</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ç›¸ç°¿ -->
    <section id="gallery" class="py-24 bg-white/40 px-6">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">ç”œèœœç¬é–“</h2>
        <div id="gallery_grid" class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        <div id="addGalleryBtn" class="hidden mt-12 text-center">
            <button onclick="triggerFilePicker('addGallery')" class="bg-pink-500 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:bg-pink-600 transition">
                ä¸€æ¬¡é¸å–å¤šå¼µç…§ç‰‡æ–°å¢
            </button>
        </div>
    </section>

    <!-- æ‚„æ‚„è©± -->
    <section id="guestbook" class="py-24 px-6 max-w-2xl mx-auto">
        <div class="glass-morphism p-10 rounded-[2.5rem] shadow-xl text-center">
            <h2 class="text-3xl font-bold text-pink-400 mb-8 cute-title">æ‚„æ‚„è©±ç‰†</h2>
            <div id="messageBox" class="mb-8 space-y-4 max-h-80 overflow-y-auto pr-2 text-sm text-left">
                <div class="text-center py-4 text-gray-400" id="loadingMsg">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="flex flex-col space-y-4">
                <input id="userName" type="text" placeholder="ä½ çš„ç¨±å‘¼" class="px-5 py-3 rounded-full border border-pink-100 outline-none">
                <textarea id="userMsg" rows="3" placeholder="æƒ³å°å‘æ™´èªªä»€éº¼ï¼Ÿ" class="px-5 py-3 rounded-3xl border border-pink-100 outline-none"></textarea>
                <button id="sendBtn" class="w-full bg-pink-400 text-white font-bold py-4 rounded-full hover:bg-pink-500 shadow-lg">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-gray-400 text-sm">
        <p>Â© 2025 é„­å‘æ™´å°å¯æ„› â¤ï¸ | 
            <button onclick="openLogin()" id="loginBtn" class="hover:text-pink-300 underline decoration-dotted">ç®¡ç†å“¡ç™»å…¥</button>
            <button onclick="handleLogout()" id="logoutBtn" class="hidden hover:text-red-400">ç™»å‡ºç®¡ç†</button>
        </p>
    </footer>

    <script>
        function openLogin() { document.getElementById('loginModal').classList.remove('hidden'); }
        function closeLogin() { document.getElementById('loginModal').classList.add('hidden'); document.getElementById('passwordInput').value = ''; }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, appId, configRef;
        const GITHUB_URL = "https://shalukuc-debug.github.io/shana/";

        const formatPath = (p) => {
            if (!p) return "";
            if (p.startsWith('http') || p.startsWith('data:')) return p;
            if (!window.location.hostname.includes('github.io')) return GITHUB_URL + p;
            return p;
        };

        // é è¨­è³‡æ–™
        const defaultPhotos = {
            hero: '20250206_153614.jpg', heroStyle: { scale: 1, x: 0, y: 0 },
            about: '20250104_193151.jpg', aboutStyle: { scale: 1, x: 0, y: 0 },
            gallery: ['20250205_194430.jpg', '20250129_082834.jpg', '20250112_162245.jpg']
        };

        let user = null;
        let isAdmin = false;
        let currentPhotoData = defaultPhotos;

        // Firebase åˆå§‹åŒ–
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
                configRef = doc(db, 'artifacts', appId, 'public', 'data', 'photoConfig', 'default');
                initAuth();
            } else { renderPhotos(null); }
        } catch (e) { renderPhotos(null); }

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => { if (u) { user = u; syncPhotos(); syncMessages(); } });
            } catch (e) { console.error(e); }
        }

        // --- ç™»å…¥é‚è¼¯ä¿®æ­£ï¼šç¢ºä¿ç¨ç«‹é‹ä½œä¸”å³æ™‚åæ‡‰ ---
        function performLogin() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === "1234") {
                isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('addGalleryBtn').classList.remove('hidden');
                closeLogin();
                showToast("ç®¡ç†å“¡å·²æˆåŠŸç™»å…¥ï¼âœ¨");
                renderPhotos(currentPhotoData);
            } else {
                alert("å¯†ç¢¼ä¸æ­£ç¢ºï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
            }
        }

        // ç¶å®šé»æ“Šäº‹ä»¶èˆ‡ Enter éµ
        document.getElementById('loginConfirmBtn').onclick = performLogin;
        document.getElementById('passwordInput').onkeypress = (e) => { if (e.key === 'Enter') performLogin(); };

        window.handleLogout = () => {
            isAdmin = false;
            document.body.classList.remove('is-admin');
            document.getElementById('adminBadge').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('addGalleryBtn').classList.add('hidden');
            showToast("å·²ç™»å‡ºç®¡ç†æ¨¡å¼ã€‚");
            renderPhotos(currentPhotoData);
        };

        // --- æ‹–æ›³èª¿æ•´é‚è¼¯ ---
        let adjustState = { target: null, isDragging: false, startX: 0, startY: 0, currentX: 0, currentY: 0, scale: 1 };

        window.enterAdjustMode = (type) => {
            adjustState.target = type;
            const style = currentPhotoData[`${type}Style`] || { scale: 1, x: 0, y: 0 };
            adjustState.currentX = style.x;
            adjustState.currentY = style.y;
            adjustState.scale = style.scale;

            document.body.classList.add('is-adjusting');
            document.getElementById(`${type}_container`).classList.add('adjust-mode');
            document.getElementById(`${type}_highlight`).classList.remove('hidden');
            document.getElementById('adjustToolbar').classList.remove('hidden');
            
            const slider = document.getElementById('scaleSlider');
            slider.value = adjustState.scale;
            slider.oninput = (e) => { adjustState.scale = parseFloat(e.target.value); updateTransform(); };

            const img = document.getElementById(`img_${type}`);
            img.style.cursor = 'move';
            img.onmousedown = startDrag;
            img.ontouchstart = startDrag;
            
            showToast("æ‹–æ›³ç…§ç‰‡æ±ºå®šé¡¯ç¤ºä½ç½®ï¼Œæ»‘æ¡¿èª¿æ•´ç¸®æ”¾");
        };

        function startDrag(e) {
            adjustState.isDragging = true;
            const event = e.touches ? e.touches[0] : e;
            adjustState.startX = event.clientX - adjustState.currentX;
            adjustState.startY = event.clientY - adjustState.currentY;
            window.onmousemove = drag;
            window.ontouchmove = drag;
            window.onmouseup = endDrag;
            window.ontouchend = endDrag;
            e.preventDefault();
        }

        function drag(e) {
            if (!adjustState.isDragging) return;
            const event = e.touches ? e.touches[0] : e;
            adjustState.currentX = event.clientX - adjustState.startX;
            adjustState.currentY = event.clientY - adjustState.startY;
            updateTransform();
        }

        function endDrag() { adjustState.isDragging = false; window.onmousemove = null; window.ontouchmove = null; }

        function updateTransform() {
            const img = document.getElementById(`img_${adjustState.target}`);
            if (img) {
                img.style.objectFit = "contain";
                img.style.width = "auto";
                img.style.height = "auto";
                img.style.minWidth = "100%";
                img.style.minHeight = "100%";
                img.style.transform = `translate3d(${adjustState.currentX}px, ${adjustState.currentY}px, 0) scale(${adjustState.scale})`;
            }
        }

        window.saveVisualTransform = async () => {
            const type = adjustState.target;
            const newData = { ...currentPhotoData };
            newData[`${type}Style`] = { scale: adjustState.scale, x: adjustState.currentX, y: adjustState.currentY };
            
            try {
                await setDoc(configRef, newData);
                document.body.classList.remove('is-adjusting');
                document.querySelectorAll('.adjust-mode').forEach(el => el.classList.remove('adjust-mode'));
                document.querySelectorAll('.adjust-highlight').forEach(el => el.classList.add('hidden'));
                document.getElementById('adjustToolbar').classList.add('hidden');
                showToast("ä½ç½®å·²å„²å­˜è‡³é›²ç«¯ï¼âœ¨");
            } catch (e) { showToast("å„²å­˜å¤±æ•—"); }
        };

        function renderPhotos(data) {
            const finalData = data || defaultPhotos;
            currentPhotoData = finalData;
            
            const applyStyle = (id, style) => {
                const img = document.getElementById(id);
                if (style && img) {
                    img.style.objectFit = "contain";
                    img.style.width = "auto";
                    img.style.height = "auto";
                    img.style.minWidth = "100%";
                    img.style.minHeight = "100%";
                    img.style.transform = `translate3d(${style.x}px, ${style.y}px, 0) scale(${style.scale})`;
                }
            };

            document.getElementById('img_hero').src = formatPath(finalData.hero);
            applyStyle('img_hero', finalData.heroStyle);

            document.getElementById('img_about').src = formatPath(finalData.about);
            applyStyle('img_about', finalData.aboutStyle);

            const grid = document.getElementById('gallery_grid');
            const uniqueGallery = [...new Set(finalData.gallery || [])];
            grid.innerHTML = uniqueGallery.map((name, idx) => `
                <div class="gallery-item aspect-square shadow-sm photo-container relative">
                    <img src="${formatPath(name)}" class="w-full h-full object-cover" draggable="false"
                         onerror="this.src='https://via.placeholder.com/400x400/ffb7c5/ffffff?text=Wait+Upload'">
                    <div class="photo-edit-overlay flex-col gap-2" onclick="triggerFilePicker('gallery_${idx}')">
                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">æ›´æ›</span>
                        ${isAdmin ? `<button onclick="event.stopPropagation(); deleteGalleryItem('${name}')" class="mt-4 bg-red-500/80 px-3 py-1 rounded-full text-[10px]">åˆªé™¤</button>` : ''}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function syncPhotos() { onSnapshot(configRef, (snap) => renderPhotos(snap.exists() ? snap.data() : null)); }

        window.triggerFilePicker = (target) => {
            if (!isAdmin) return;
            window.currentEditingTarget = target;
            document.getElementById('filePicker').click();
        };

        document.getElementById('filePicker').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length || !currentPhotoData) return;
            const newData = { ...currentPhotoData };
            const target = window.currentEditingTarget;
            if (target === 'hero') newData.hero = files[0].name;
            else if (target === 'about') newData.about = files[0].name;
            else if (target === 'addGallery') {
                const names = Array.from(files).map(f => f.name);
                newData.gallery = [...new Set([...(newData.gallery || []), ...names])];
            } else if (target.startsWith('gallery_')) {
                const idx = parseInt(target.split('_')[1]);
                newData.gallery[idx] = files[0].name;
            }
            try { await setDoc(configRef, newData); showToast(`ç…§ç‰‡å·²æ›´æ–°ï¼âœ¨`); } catch (err) { alert("åŒæ­¥å¤±æ•—"); }
            e.target.value = ''; 
        };

        window.deleteGalleryItem = async (fileName) => {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            const newData = { ...currentPhotoData };
            newData.gallery = newData.gallery.filter(name => name !== fileName);
            await setDoc(configRef, newData);
        };

        function syncMessages() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                const loading = document.getElementById('loadingMsg'); if (loading) loading.remove();
                const msgs = []; snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                document.getElementById('messageBox').innerHTML = msgs.map(m => `
                    <div class="bg-white/90 p-4 rounded-2xl shadow-sm border-l-4 border-pink-300">
                        <span class="font-bold text-pink-500">${m.name || 'è¨ªå®¢'}:</span> ${m.content}
                    </div>
                `).join('') || '<div class="text-center text-gray-400 py-4">ç›®å‰å°šç„¡æ‚„æ‚„è©±</div>';
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const n = document.getElementById('userName').value, c = document.getElementById('userMsg').value;
            if (!n || !c) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), { name: n, content: c, createdAt: serverTimestamp() });
            document.getElementById('userName').value = ''; document.getElementById('userMsg').value = '';
            createHearts();
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };
        lucide.createIcons();
    </script>

    <script>
        function createHearts(e) {
            const x = e ? e.clientX : window.innerWidth/2, y = e ? e.clientY : window.innerHeight/2;
            for(let i=0; i<15; i++) {
                const h = document.createElement('div');
                h.innerHTML = ['ğŸ’–','ğŸ’—','âœ¨','ğŸŒ¸','ğŸ­'][Math.floor(Math.random()*5)];
                h.className = 'heart-particle text-3xl';
                h.style.left = x + (Math.random()-0.5)*180 + 'px';
                h.style.top = y + (Math.random()-0.5)*180 + 'px';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 2000);
            }
        }
    </script>
</body>
</html>

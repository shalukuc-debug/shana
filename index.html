<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é„­å‘æ™´å°å¯æ„›çš„å€‹äººç©ºé–“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <!-- ä½¿ç”¨ Lucide åœ–ç¤º -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary-pink: #ffb7c5; --soft-purple: #e2d1f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #fff5f7 0%, #f0f4ff 100%); scroll-behavior: smooth; overflow-x: hidden; }
        .cute-title { font-family: 'Zhi Mang Xing', cursive, sans-serif; }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .heart-particle { position: absolute; pointer-events: none; animation: flyUp 2s linear forwards; z-index: 100; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .glass-morphism { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        /* ç…§ç‰‡ç·¨è¼¯é®ç½© */
        .photo-edit-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer; color: white;
            z-index: 20; border-radius: inherit; pointer-events: none;
        }
        body.is-admin .photo-container:hover .photo-edit-overlay { opacity: 1; pointer-events: auto; }
        
        .gallery-item { overflow: hidden; position: relative; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(255, 183, 197, 0.3); background: #fff; transition: all 0.3s ease; }
        .gallery-item img { transition: transform 0.5s ease; width: 100%; height: 100%; object-fit: cover; min-height: 200px; }
        .gallery-item:hover { transform: translateY(-5px); }
        .gallery-item:hover img { transform: scale(1.1); }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #ff69b4; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }

        /* è¼‰å…¥å‹•ç•« */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ff69b4; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast">è¨­å®šå·²æ›´æ–°ï¼âœ¨</div>

    <!-- ç™»å…¥å½ˆçª— -->
    <div id="loginModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl">
            <h3 class="text-2xl font-bold text-pink-500 mb-6 text-center">ç®¡ç†å“¡ç™»å…¥</h3>
            <input id="passwordInput" type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full px-5 py-3 rounded-full border border-pink-100 mb-4 outline-none focus:ring-2 focus:ring-pink-300">
            <div class="flex space-x-2">
                <button onclick="closeLogin()" class="flex-1 py-3 rounded-full bg-gray-100 text-gray-500 font-bold">å–æ¶ˆ</button>
                <button id="loginConfirmBtn" class="flex-1 py-3 rounded-full bg-pink-400 text-white font-bold shadow-lg hover:bg-pink-500">ç™»å…¥</button>
            </div>
            <p class="text-center text-xs text-gray-400 mt-4">é è¨­å¯†ç¢¼ï¼š1234</p>
        </div>
    </div>

    <!-- æª”æ¡ˆé¸å–å™¨ (æ”¯æ´è¤‡é¸) -->
    <input type="file" id="filePicker" class="hidden" accept="image/*" multiple>

    <nav class="fixed w-full z-50 glass-morphism px-6 py-4 flex justify-between items-center">
        <div class="text-2xl font-bold text-pink-500">å‘æ™´ ğŸ¬</div>
        <div class="space-x-4 md:space-x-6 hidden sm:flex">
            <a href="#home" class="hover:text-pink-400 transition">é¦–é </a>
            <a href="#about" class="hover:text-pink-400 transition">é—œæ–¼æˆ‘</a>
            <a href="#gallery" class="hover:text-pink-400 transition">ç”œèœœç¬é–“</a>
            <a href="#guestbook" class="hover:text-pink-400 transition">æ‚„æ‚„è©±</a>
        </div>
        <div id="adminBadge" class="hidden bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-xs font-bold animate-pulse border border-pink-200">
            ç®¡ç†æ¨¡å¼ä¸­
        </div>
    </nav>

    <!-- ä¸»è¦–è¦º -->
    <section id="home" class="min-h-screen flex flex-col items-center justify-center pt-20 overflow-hidden relative">
        <div class="absolute inset-0 pointer-events-none opacity-20">
            <div class="absolute top-20 left-10 text-4xl floating">â­</div>
            <div class="absolute bottom-20 right-10 text-4xl floating" style="animation-delay: 1s;">ğŸ­</div>
        </div>
        <div class="text-center z-10 px-4">
            <div class="mb-6 inline-block p-4 rounded-full bg-white shadow-xl floating relative photo-container">
                <div class="w-44 h-44 md:w-60 md:h-60 rounded-full overflow-hidden border-8 border-pink-100 bg-pink-50">
                    <img id="img_hero" src="20250206_153614.jpg" alt="å‘æ™´å¤§é ­ç…§" class="w-full h-full object-cover">
                </div>
                <div class="photo-edit-overlay" onclick="triggerFilePicker('hero')">
                    <div class="text-center">
                        <i data-lucide="camera" class="mx-auto mb-1"></i>
                        <p class="text-xs font-bold">æ›´æ›å¤§é ­ç…§</p>
                    </div>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-pink-500 mb-4 cute-title">é„­å‘æ™´å°å¯æ„›</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">æ”¶é›†ä¸–é–“æ‰€æœ‰çš„æº«æŸ”èˆ‡å¯æ„› âœ¨</p>
            <button onclick="createHearts(event)" class="bg-pink-400 hover:bg-pink-500 text-white px-10 py-4 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 text-lg font-bold">
                é€æˆ‘æ„›å¿ƒ ğŸ’–
            </button>
        </div>
    </section>

    <!-- é—œæ–¼æˆ‘ -->
    <section id="about" class="py-24 px-6 max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">é—œæ–¼å°å¯æ„›</h2>
        <div class="grid md:grid-cols-2 gap-12 items-center">
            <div class="glass-morphism p-10 rounded-3xl shadow-sm leading-relaxed text-gray-700">
                <p class="text-xl mb-6">å—¨ï¼æˆ‘æ˜¯å‘æ™´ï¼Œå¤§å®¶å…¬èªçš„å°å¯æ„›ã€‚æˆ‘å–œæ­¡çœ‹æ›¸ã€å½ˆç´ï¼Œä¹Ÿå–œæ­¡å’Œå®¶äººåˆ°è™•å»å†’éšªåƒç¾é£Ÿï¼</p>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50">
                        <span class="block text-3xl">ğŸ“</span>
                        <span class="text-sm font-bold text-pink-400">æ„›åƒè‰è“</span>
                    </div>
                    <div class="bg-white/80 p-4 rounded-2xl shadow-sm border border-pink-50">
                        <span class="block text-3xl">ğŸ¶</span>
                        <span class="text-sm font-bold text-pink-400">å°å°éŸ³æ¨‚å®¶</span>
                    </div>
                </div>
            </div>
            <div class="relative photo-container">
                <div class="rounded-3xl overflow-hidden shadow-2xl rotate-2 border-[12px] border-white bg-pink-50">
                    <img id="img_about" src="20250104_193151.jpg" alt="é—œæ–¼æˆ‘ç…§ç‰‡" class="w-full h-80 object-cover">
                </div>
                <div class="photo-edit-overlay rotate-2" onclick="triggerFilePicker('about')">
                    <div class="text-center">
                        <i data-lucide="camera" class="mx-auto mb-1"></i>
                        <p class="text-xs font-bold">æ›´æ›ç…§ç‰‡</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ç›¸ç°¿ -->
    <section id="gallery" class="py-24 bg-white/40 px-6">
        <h2 class="text-4xl font-bold text-center text-pink-400 mb-12 cute-title">ç”œèœœç¬é–“</h2>
        <div id="gallery_grid" class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- åœ–ç‰‡å‹•æ…‹è¼‰å…¥ -->
        </div>
        <!-- ç®¡ç†å“¡å°ˆç”¨ï¼šæ‰¹æ¬¡æ–°å¢ -->
        <div id="addGalleryBtn" class="hidden mt-12 text-center">
            <button id="multiUploadBtn" onclick="triggerFilePicker('addGallery')" class="bg-pink-500 text-white px-10 py-4 rounded-2xl font-bold shadow-lg hover:bg-pink-600 transition flex items-center mx-auto">
                <i data-lucide="plus-circle" class="mr-2"></i> ä¸€æ¬¡é¸å–å¤šå¼µç…§ç‰‡æ–°å¢
            </button>
            <p class="text-xs text-gray-400 mt-3">æç¤ºï¼šé»æ“Šå¾ŒæŒ‰ä½ Ctrl æˆ– Shift å¯é¸å–å¤šå¼µç…§ç‰‡</p>
        </div>
    </section>

    <!-- æ‚„æ‚„è©± -->
    <section id="guestbook" class="py-24 px-6 max-w-2xl mx-auto">
        <div class="glass-morphism p-10 rounded-[2.5rem] shadow-xl text-center">
            <h2 class="text-3xl font-bold text-pink-400 mb-8 cute-title">æ‚„æ‚„è©±ç‰†</h2>
            <div id="messageBox" class="mb-8 space-y-4 max-h-80 overflow-y-auto pr-2 text-sm text-left">
                <div class="text-center py-4 text-gray-400" id="loadingMsg">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="flex flex-col space-y-4">
                <input id="userName" type="text" placeholder="ä½ çš„ç¨±å‘¼" class="px-5 py-3 rounded-full border border-pink-100 outline-none">
                <textarea id="userMsg" rows="3" placeholder="æƒ³å°å‘æ™´èªªä»€éº¼ï¼Ÿ" class="px-5 py-3 rounded-3xl border border-pink-100 outline-none"></textarea>
                <button id="sendBtn" class="w-full bg-pink-400 text-white font-bold py-4 rounded-full hover:bg-pink-500 shadow-lg transition">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-gray-400 text-sm">
        <div class="mb-4 space-x-2">
            <span id="cloudStatus" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                <span class="w-2 h-2 mr-1 bg-gray-400 rounded-full"></span> é›²ç«¯é€£ç·šä¸­...
            </span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">ç‰ˆæœ¬: 2026.02.04.3</span>
        </div>
        <p>Â© 2025 é„­å‘æ™´å°å¯æ„›å°ˆå±¬ç©ºé–“ â¤ï¸ | 
            <button onclick="openLogin()" id="loginBtn" class="hover:text-pink-300">ç®¡ç†å“¡ç™»å…¥</button>
            <button onclick="handleLogout()" id="logoutBtn" class="hidden hover:text-red-400">ç™»å‡ºç®¡ç†</button>
        </p>
    </footer>

    <script>
        function openLogin() { document.getElementById('loginModal').classList.remove('hidden'); }
        function closeLogin() { document.getElementById('loginModal').classList.add('hidden'); document.getElementById('passwordInput').value = ''; }
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('loginConfirmBtn').click();
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, appId, configRef;
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
            configRef = doc(db, 'artifacts', appId, 'public', 'data', 'photoConfig', 'default');
        } catch (e) { console.error("Firebase Init Error"); }
        
        let user = null;
        let isAdmin = false;
        let currentEditingTarget = null;
        let currentPhotoData = null;

        const defaultPhotos = {
            hero: '20250206_153614.jpg',
            about: '20250104_193151.jpg',
            gallery: [
                '20250205_194430.jpg', '20250129_082834.jpg', '20250112_162245.jpg',
                '20250104_172109.jpg', '20250104_172053.jpg', '20250104_171603.jpg'
            ]
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        const initAuth = async () => {
            if (!auth) return;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth().then(() => {
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    const status = document.getElementById('cloudStatus');
                    status.innerHTML = '<span class="w-2 h-2 mr-1 bg-green-500 rounded-full"></span> é›²ç«¯å·²åŒæ­¥';
                    syncPhotos();
                    syncMessages();
                }
            });
        });

        // ç™»å…¥è™•ç†
        const ADMIN_PWD = "1234";
        document.getElementById('loginConfirmBtn').onclick = () => {
            if (document.getElementById('passwordInput').value === ADMIN_PWD) {
                isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('addGalleryBtn').classList.remove('hidden');
                closeLogin();
                showToast("æ­¡è¿å›ä¾†ï¼Œç®¡ç†å“¡ï¼âœ¨");
                lucide.createIcons();
                syncPhotos();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        };

        window.handleLogout = () => {
            isAdmin = false;
            document.body.classList.remove('is-admin');
            document.getElementById('adminBadge').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('addGalleryBtn').classList.add('hidden');
            showToast("å·²ç™»å‡ºã€‚");
            syncPhotos();
        };

        // ç…§ç‰‡æ“ä½œ
        window.triggerFilePicker = (target) => {
            if (!isAdmin) return;
            currentEditingTarget = target;
            document.getElementById('filePicker').click();
        };

        document.getElementById('filePicker').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length || !currentPhotoData) return;
            
            const newData = { ...currentPhotoData };
            const uploadBtn = document.getElementById('multiUploadBtn');
            const originalText = uploadBtn ? uploadBtn.innerHTML : "";
            
            if (uploadBtn) uploadBtn.innerHTML = `<span class="loader"></span> è™•ç†ä¸­...`;

            if (currentEditingTarget === 'hero') {
                newData.hero = files[0].name;
            } else if (currentEditingTarget === 'about') {
                newData.about = files[0].name;
            } else if (currentEditingTarget === 'addGallery') {
                const newNames = Array.from(files).map(f => f.name);
                newData.gallery = [...(newData.gallery || []), ...newNames];
            } else if (currentEditingTarget.startsWith('gallery_')) {
                const index = parseInt(currentEditingTarget.split('_')[1]);
                newData.gallery[index] = files[0].name;
            }

            try {
                await setDoc(configRef, newData);
                showToast(`æˆåŠŸè™•ç† ${files.length} å€‹æª”æ¡ˆï¼âœ¨`);
            } catch (err) {
                showToast("é›²ç«¯åŒæ­¥å¤±æ•—");
            } finally {
                if (uploadBtn) uploadBtn.innerHTML = originalText;
                e.target.value = ''; 
            }
        };

        window.deleteGalleryItem = async (index) => {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) return;
            const newData = { ...currentPhotoData };
            newData.gallery.splice(index, 1);
            await setDoc(configRef, newData);
            showToast("ç…§ç‰‡å·²ç§»é™¤ã€‚");
        };

        function syncPhotos() {
            onSnapshot(configRef, (snap) => {
                currentPhotoData = snap.exists() ? snap.data() : defaultPhotos;
                const data = currentPhotoData;

                // ç§»é™¤è·¯å¾‘ä¸­çš„ ./ å¢åŠ ç›¸å®¹æ€§
                document.getElementById('img_hero').src = data.hero;
                document.getElementById('img_about').src = data.about;

                const grid = document.getElementById('gallery_grid');
                grid.innerHTML = (data.gallery || []).map((name, idx) => `
                    <div class="gallery-item aspect-square shadow-sm photo-container relative">
                        <img src="${name}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400?text=Wait+Upload'">
                        <div class="photo-edit-overlay flex-col gap-2" onclick="triggerFilePicker('gallery_${idx}')">
                            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                            <span class="text-xs font-bold">é»æ“Šæ›´æ›</span>
                            ${isAdmin ? `<button onclick="event.stopPropagation(); deleteGalleryItem(${idx})" class="mt-4 bg-red-500/80 px-3 py-1 rounded-full text-[10px]">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            });
        }

        function syncMessages() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                const loading = document.getElementById('loadingMsg'); if (loading) loading.remove();
                const msgs = []; snap.forEach(doc => msgs.push(doc.data()));
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                document.getElementById('messageBox').innerHTML = msgs.map(m => `
                    <div class="bg-white/90 p-4 rounded-2xl shadow-sm border-l-4 border-pink-300">
                        <span class="font-bold text-pink-500">${m.name || 'è¨ªå®¢'}:</span> ${m.content}
                    </div>
                `).join('') || '<div class="text-center text-gray-400 py-4">å°šç„¡ç•™è¨€</div>';
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const n = document.getElementById('userName').value, c = document.getElementById('userMsg').value;
            if (!user || !n || !c) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                name: n, content: c, createdAt: serverTimestamp()
            });
            document.getElementById('userName').value = ''; document.getElementById('userMsg').value = '';
            createHearts();
        };
        lucide.createIcons();
    </script>

    <script>
        function createHearts(e) {
            const x = e ? e.clientX : window.innerWidth/2, y = e ? e.clientY : window.innerHeight/2;
            for(let i=0; i<15; i++) {
                const h = document.createElement('div');
                h.innerHTML = ['ğŸ’–','ğŸ’—','âœ¨','ğŸŒ¸','ğŸ­'][Math.floor(Math.random()*5)];
                h.className = 'heart-particle text-3xl';
                h.style.left = x + (Math.random()-0.5)*180 + 'px';
                h.style.top = y + (Math.random()-0.5)*180 + 'px';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 2000);
            }
        }
    </script>
</body>
</html>
